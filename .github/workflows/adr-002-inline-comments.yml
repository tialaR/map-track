name: ADR-002 Inline Feedback

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  adr-002-inline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with JSON output
        run: |
          npx eslint "src/**/*.{ts,tsx}" -f json -o eslint-report.json || true

      - name: Comment ADR-002 inline violations
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const report = JSON.parse(
              fs.readFileSync("eslint-report.json", "utf8")
            );

            const explanations = {
              "local/no-side-effects-in-components": {
                title: "‚ùå Side effect inside component",
                message:
                  "React components must remain declarative.\n\n" +
                  "üî¥ Problem: A side effect is being executed during render or JSX evaluation.\n\n" +
                  "This breaks React's mental model and may cause unexpected behavior.\n\n" +
                  "‚úÖ Fix:\n" +
                  "- Move this logic to `useEffect`\n" +
                  "- Or extract it into a dedicated hook (e.g. `useCreateUser`)\n\n" +
                  "üìå Rule: Components render ‚Üí hooks define behavior"
              },

              "local/no-fake-hooks": {
                title: "‚ùå Fake Hook detected",
                message:
                  "Hooks must encapsulate state or side effects.\n\n" +
                  "üî¥ Problem: This function is named like a hook but does not use React state or effects.\n\n" +
                  "This creates architectural confusion and violates React conventions.\n\n" +
                  "‚úÖ Fix:\n" +
                  "- Rename this function to a util or service\n" +
                  "- OR introduce state/effect if it truly represents behavior\n\n" +
                  "üìå Rule: `use*` implies React behavior"
              }
            };

            for (const file of report) {
              for (const msg of file.messages) {
                if (!msg.ruleId || !msg.ruleId.startsWith("local/")) {
                  continue;
                }

                const explanation = explanations[msg.ruleId];

                const body = explanation
                  ? `**${explanation.title}**\n\n${explanation.message}\n\nüìò See \`docs/adr/ADR-002.md\``
                  : `‚ùå **ADR-002 violation**\n\nRule: \`${msg.ruleId}\`\n\n${msg.message}`;

                await github.rest.pulls.createReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  commit_id: context.payload.pull_request.head.sha,
                  path: file.filePath.replace(process.cwd() + "/", ""),
                  line: msg.line,
                  side: "RIGHT",
                  body
                });
              }
            }
